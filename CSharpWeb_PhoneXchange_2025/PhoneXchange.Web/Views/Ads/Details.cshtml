@model PhoneXchange.Web.ViewModels.Ad.AdDetailsViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<PhoneXchange.Data.Models.ApplicationUser> UserManager
@inject SignInManager<PhoneXchange.Data.Models.ApplicationUser> SignInManager
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Title;



    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);

    bool isLoggedIn = SignInManager.IsSignedIn(User);

    bool isOwner = currentUserId == Model.OwnerId;
}

<h2>@Model.Title</h2>

<div>
    <strong>Марка:</strong> @Model.BrandName<br />
    <strong>Модел:</strong> @Model.Model<br />
    <strong>Операционна система:</strong> @Model.OS<br />
    <strong>Състояние:</strong> @(Model.IsNew ? "Ново" : "Употребявано")<br />
    <strong>Цена:</strong> <span class="text-success fw-bold">@Model.Price лв.</span><br />
</div>

@if (Model.ImageUrls.Any())

{
    <div class="my-3">
        @foreach (var url in Model.ImageUrls)

        {
            <img src="@url" alt="Снимка" style="max-width: 250px; margin-right: 10px;" />
        }
    </div>
}

<hr />

<h4>Ревюта (общо @Model.ReviewsCount)</h4>
@if (Model.Reviews.Any())

{
    <ul class="list-group">
        @foreach (var review in Model.Reviews)

        {
            <li class="list-group-item">
                <strong>@review.AuthorEmail</strong> —
                <em>@review.Rating/5</em><br />
                <span>@review.Comment</span><br />
                <small class="text-muted">@review.CreatedOn.ToString("g")</small>
            </li>
        }
    </ul>
}

else

{
    <p>Няма налични ревюта.</p>
}

<hr />

@if (isLoggedIn && !isOwner)

{
    <h4>Изпрати съобщение до продавача</h4>
    <form asp-action="Send" asp-controller="Messages" method="post">
        @Html.AntiForgeryToken()

        <input type="hidden" name="RecipientId" value="@Model.OwnerId" />
        <input type="hidden" name="AdId" value="@Model.Id" />

        <div class="mb-3">
            <label for="Content" class="form-label">Съобщение:</label>
            <textarea name="Content" class="form-control" required rows="3" maxlength="1000"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Изпрати</button>
    </form>
}

else if (!isLoggedIn)

{
    <p class="text-muted mt-4">Влезте в профила си, за да можете да изпращате съобщения.</p>
}

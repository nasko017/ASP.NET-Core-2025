@model PhoneXchange.Web.ViewModels.Ad.AdDetailsViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<PhoneXchange.Data.Models.ApplicationUser> UserManager
@inject SignInManager<PhoneXchange.Data.Models.ApplicationUser> SignInManager
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Title;



    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);

    bool isLoggedIn = SignInManager.IsSignedIn(User);

    bool isOwner = currentUserId == Model.OwnerId;
}

<h2>@Model.Title</h2>

<div>
    <strong>Марка:</strong> @Model.BrandName<br />
    <strong>Модел:</strong> @Model.Model<br />
    <strong>Операционна система:</strong> @Model.OS<br />
    <strong>Състояние:</strong> @(Model.IsNew ? "Ново" : "Употребявано")<br />
    <strong>Цена:</strong> <span class="text-success fw-bold">@Model.Price лв.</span><br />
</div>

@if (Model.ImageUrls.Any())

{
    <div class="my-3">
        @foreach (var url in Model.ImageUrls)

        {
            <img src="@url" alt="Снимка" style="max-width: 250px; margin-right: 10px;" />
        }
    </div>
}

<hr />

<h4>Ревюта (общо @Model.ReviewsCount)</h4>

@if (Model.Reviews.Any())

{
    <ul class="list-group">
        @foreach (var review in Model.Reviews)

        {
            <li class="list-group-item">
                <strong>@review.AuthorEmail</strong> —
                <em>@review.Rating/5</em><br />
                <span>@review.Comment</span><br />
                <small class="text-muted">@review.CreatedOn.ToString("g")</small>
            </li>
        }
    </ul>
}

else

{
    <p>Няма налични ревюта.</p>
}

@if (isLoggedIn && !isOwner)

{
    <hr />
    <h4>Остави ревю за тази обява</h4>

    <form asp-controller="Reviews" asp-action="Add" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="AdId" value="@Model.Id" />

        <div class="mb-3">
            <label for="Rating" class="form-label">Оценка (1-5):</label>
            <input type="number" name="Rating" class="form-control" min="1" max="5" required />
        </div>

        <div class="mb-3">
            <label for="Comment" class="form-label">Коментар:</label>
            <textarea name="Comment" class="form-control" required maxlength="1000"></textarea>
        </div>

        <button type="submit" class="btn btn-success">Изпрати ревю</button>
    </form>

    <hr />
    <form asp-controller="Favorites" asp-action="Toggle" method="post" class="mt-3">
        <input type="hidden" name="adId" value="@Model.Id" />
        <button type="submit" class="btn @(Model.IsFavorite ? "btn-warning" : "btn-outline-warning")">
            <i class="bi @(Model.IsFavorite ? "bi-star-fill" : "bi-star")"></i>
            @(Model.IsFavorite ? "Премахни от любими" : "Добави в любими")
        </button>
    </form>

    <hr />
    <h4>Изпрати съобщение до продавача</h4>
    <form asp-action="Send" asp-controller="Messages" method="post">
        @Html.AntiForgeryToken()

        <input type="hidden" name="RecipientId" value="@Model.OwnerId" />
        <input type="hidden" name="AdId" value="@Model.Id" />

        <div class="mb-3">
            <label for="Content" class="form-label">Съобщение:</label>
            <textarea name="Content" class="form-control" required rows="3" maxlength="1000"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Изпрати</button>
    </form>
}

else if (!isLoggedIn)

{
    <p class="text-muted mt-4">Влезте в профила си, за да можете да изпращате съобщения, ревюта и да добавяте в любими.</p>
}
